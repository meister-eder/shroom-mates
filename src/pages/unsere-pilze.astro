---
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";

const title = "Unsere Edelpilze | shroom-mates";
const description =
  "Frische Edelpilze aus Leipzig: Rosenseitling, Pioppino, Lion's Mane und White Pearl. Nachhaltig angebaut in der Plagwitzer Markthalle mit regionalen Bio-Rohstoffen.";
const noBackground = true;

// Get mushrooms from the mushrooms collection and render their content
const mushroomsCollection = await getCollection("mushrooms");
const mushrooms = await Promise.all(
  mushroomsCollection
    .sort((a, b) => a.data.order - b.data.order)
    .map(async (entry) => {
      const { Content } = await render(entry);
      return {
        title: entry.data.title,
        image: entry.data.image,
        imageAlt: entry.data.imageAlt,
        Content, // Rendered component instead of raw body
        color: entry.data.color,
      };
    })
);

// Helper: choose readable text color (black or white) based on a hex/rgb background
const readableTextColor = (bg: string | undefined): string => {
  if (!bg) return "#111";
  try {
    // Normalize hex shorthand
    const hexMatch = bg.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
    let r, g, b;
    if (hexMatch) {
      const hex = hexMatch[1];
      if (hex.length === 3) {
        r = parseInt(hex[0] + hex[0], 16);
        g = parseInt(hex[1] + hex[1], 16);
        b = parseInt(hex[2] + hex[2], 16);
      } else {
        r = parseInt(hex.slice(0, 2), 16);
        g = parseInt(hex.slice(2, 4), 16);
        b = parseInt(hex.slice(4, 6), 16);
      }
    } else {
      // Try rgb(...) format
      const rgbMatch = bg.match(/rgba?\(([^)]+)\)/i);
      if (rgbMatch) {
        const parts = rgbMatch[1]
          .split(",")
          .map((s: string) => parseFloat(s.trim()));
        r = parts[0];
        g = parts[1];
        b = parts[2];
      } else {
        return "#111";
      }
    }

    // Perceived luminance
    const [R, G, B] = [r, g, b].map((c) => {
      const v = c / 255;
      return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    });
    const lum = 0.2126 * R + 0.7152 * G + 0.0722 * B;
    return lum > 0.5 ? "#111" : "#fff";
  } catch (e) {
    return "#111";
  }
};
---

<style is:global>
  /* Remove checkered background for this page only */
  body:has(.full-width-page) {
    background: #ffffff;
    background-image: none;
  }

  html:has(.full-width-page) {
    background: #ffffff;
    background-image: none;
  }
</style>

<Layout title={title} description={description}>
  <main class="full-width-page">
    <div class="mushrooms-grid">
      {
        mushrooms.map((mushroom, index) => (
          <article class="mushroom-card">
            <div
              class="mushroom-content"
              style={
                mushroom.color
                  ? `background-color: ${mushroom.color}; color: ${readableTextColor(mushroom.color)};`
                  : ""
              }
            >
              <h2>{mushroom.title}</h2>
              <div class="mushroom-description">
                <mushroom.Content />
              </div>
            </div>
            <div class="mushroom-image-wrapper">
              <Image
                src={mushroom.image}
                alt={mushroom.imageAlt}
                width={1920}
                height={1080}
                format="webp"
                loading="lazy"
                class="mushroom-image"
                priority={index === 0}
              />
            </div>
          </article>
        ))
      }
    </div>

    {
      mushrooms.length === 0 && (
        <div class="no-content">
          <p>
            Derzeit sind keine Pilzsorten verfügbar. Bitte schauen Sie später
            wieder vorbei.
          </p>
        </div>
      )
    }
  </main>
</Layout>

<style>
  .full-width-page {
    padding: 0 !important;
    margin: 0 !important;
    max-width: none !important;
    min-height: 100vh;
    width: 100% !important;
    background: #ffffff;
    margin-top: var(--navbar-height);
  }

  /* Remove parent padding for flush layout */
  :global(.site-main:has(.full-width-page)) {
    padding-top: 0 !important;
  }

  .mushrooms-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .mushroom-card {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    align-items: stretch;
    min-height: 60vh;
    width: 100%;
    border-bottom: 2px solid #000;
  }

  .mushroom-card:last-child {
    border-bottom: none;
  }

  .mushroom-card:nth-child(even) .mushroom-content {
    order: 2;
  }

  .mushroom-card:nth-child(even) .mushroom-image-wrapper {
    order: 1;
  }

  .mushroom-image-wrapper {
    width: 100%;
    height: 100%;
    min-height: 60vh;
    overflow: hidden;
    position: relative;
  }

  .mushroom-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    min-height: 60vh;
  }

  .mushroom-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 4rem 6rem;
    background: #ffffff;
    height: 100%;
    justify-content: center;
  }

  .mushroom-content h2 {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 1rem 0;
    color: var(--text-color);
  }

  .mushroom-description {
    font-size: 1.1rem;
    line-height: 1.8;
    color: var(--text-color);
  }

  /* Style markdown content within description */
  .mushroom-description :global(p) {
    margin: 0 0 1rem 0;
  }

  .mushroom-description :global(p:last-child) {
    margin-bottom: 0;
  }

  .mushroom-description :global(strong) {
    font-weight: 700;
  }

  .mushroom-description :global(em) {
    font-style: italic;
  }

  .mushroom-description :global(a) {
    color: inherit;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .mushroom-description :global(a:hover) {
    text-decoration-thickness: 2px;
  }

  .no-content {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-color);
  }

  .no-content p {
    font-size: 1.2rem;
    opacity: 0.7;
  }

  /* Tablet breakpoint */
  @media (max-width: 968px) {
    .mushroom-content {
      padding: 2.5rem 3rem;
    }

    .mushroom-content h2 {
      font-size: 2rem;
    }

    .mushroom-description {
      font-size: 1rem;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    .full-width-page {
      margin-top: var(--navbar-height-mobile);
      padding-top: 0 !important;
    }

    /* Adjust parent to remove gap - match actual navbar height */
    :global(.site-main:has(.full-width-page)) {
      margin-top: 64px !important;
    }

    .mushroom-card {
      grid-template-columns: 1fr;
      min-height: auto;
      display: flex;
      flex-direction: column;
    }

    .mushroom-content {
      order: 1 !important;
    }

    .mushroom-image-wrapper {
      order: 2 !important;
    }

    .mushroom-image-wrapper {
      min-height: 50vh;
    }

    .mushroom-image {
      min-height: 50vh;
    }

    .mushroom-content {
      padding: 2rem 1.5rem;
    }

    .mushroom-content h2 {
      font-size: 1.8rem;
    }

    .mushroom-description {
      font-size: 0.95rem;
      line-height: 1.6;
    }
  }

  /* Small mobile breakpoint */
  @media (max-width: 480px) {
    .mushroom-image-wrapper {
      min-height: 40vh;
    }

    .mushroom-image {
      min-height: 40vh;
    }

    .mushroom-content {
      padding: 1.5rem 1rem;
    }

    .mushroom-content h2 {
      font-size: 1.6rem;
    }

    .mushroom-description {
      font-size: 0.9rem;
    }
  }
</style>
